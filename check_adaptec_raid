#!/usr/bin/perl -w


use strict;
use warnings;
use Getopt::Long qw(:config no_ignore_case);
use IPC::Run3;
use Data::Dumper;
use Switch;


our $VERBOSITY = 0;
our $VERSION = '0.0';

use constant { 
	STATE_OK => 0,
	STATE_WARNING => 1,
	STATE_CRITICAL => 2,
	STATE_UNKNOWN => 3,
 };


sub displayUsage {
	#foobar strings
}

sub displayHelp {
	#foobar strings
}
 
sub displayVersion {
	# Get arcconf VERSION, controller name, + VERSION of plugin 
}


sub getControllerCfg {
	
	my $sudo = $_[0];
	my $arcconf = $_[1];
	my $controller = $_[2];
	my $temperature = $_[3];
	my $status = 0; 
	my @output = `$sudo $arcconf GETCONFIG $controller AD`; #seems to parse every line in its own variable
	#$VERBOSITY = 3;
	print Dumper(@output) if $VERBOSITY == 3;
	my %hash;
	my @linevalues;
	foreach my $line (@output) {
		if(index($line, ':') != -1) {
			@linevalues = split(/:/, $line);
			$linevalues[0] =~ s/^\s+|\s+$//g;
			$linevalues[1] =~ s/^\s+|\s+$//g;
			$hash{$linevalues[0]} = $linevalues[1];
			switch($linevalues[0]) {
				case "Controller Status" { if ($linevalues[1] ne "Optimal") { print "Wirkli Schlecht.\n" }}
				case "Defunct disk drive count" { if ($linevalues[1] ne "0") { print "Gscheid Schlecht.\n" }}
				case "Logical devices/Failed/Degraded" { 
														my $degrad = $linevalues[1] =~ s/^[0-9]+//g;
														if ($degrad ne "/0/0") { print "Voi Schlecht.\n" }}
				case "Temperature" {
									my ($temp) = $linevalues[1] =~ /(^[0-9]+)/;
					 				if ( $temp > $temperature) { print "Sau schlecht und sau has!\n"}}
				case "Status" { if ($linevalues[1] ne "ZMM Optimal") { print "yuno optimal?\n" }}
				else {}
			}
		}
	}
	#print Dumper(%hash);
	return $status;
}

sub getPhysDevCfg {
	
}

sub getLogDevCfg {
	
}


sub myExit {
		print $_[1];
		exit ($_[2]);
}

MAIN: {
	my $controller = 1;
	my @logDevices; 
	my @physDevices;
	my $sudo = ''; #check_arc all nopasswd: /usr/bin/arcconf GETCONFIG *
	my $arcconf = '';
	my $platform = $^O;
 	my $temperature = ''; 
 	
	# check platform
	if ($platform eq 'linux') {
		chomp($sudo= `which sudo`);
		$arcconf = '/usr/bin/arcconf';
		unless ( -e $arcconf || -x $sudo ) { print "Permission denied or File not found!\n"; die; }
	} else {
		unless ( -e $arcconf ) { print "Permission denied or File not found!\n"; die; }
		$sudo = '';
		$arcconf = 'C:\Programme\Adaptec\RemoteArcconf\arcconf.exe';
	}
	
	
	if ( !(GetOptions(
		'v|verbose' => sub {$VERBOSITY = 1 },
		'vv' => sub {$VERBOSITY = 2},
		'vvv' => sub {$VERBOSITY = 3},
		'h|help' => sub {displayHelp();},
		'V|version' => sub {displayVersion();},
		'C|controller=i' => \$controller,
		'LD|logicaldevice=i@' => \@logDevices,
		'PD|physicaldevice=i@' => \@physDevices, 
		'T|temperature=s' => \$temperature,
		'p|path=s' => \$arcconf 
	)))	{
		displayUsage();
	}
	getControllerCfg($sudo, $arcconf, $controller, $temperature);
}